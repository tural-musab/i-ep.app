name: Documentation Auto-Sync

on:
  push:
    branches: [ main, development ]
    paths:
      - 'PROGRESS.md'
      - 'SPRINT-PLANNING-2025.md'
      - 'PROJECT-STATUS-REPORT-*.md'
      - 'DEVELOPMENT-ROADMAP-2025.md'
      - 'src/lib/storage/**'
  
  pull_request:
    branches: [ main ]
    paths:
      - 'PROGRESS.md'
      - 'SPRINT-PLANNING-2025.md'
      - 'PROJECT-STATUS-REPORT-*.md'
      - 'DEVELOPMENT-ROADMAP-2025.md'
      - 'src/lib/storage/**'

  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force documentation synchronization'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  doc-sync:
    runs-on: ubuntu-latest
    name: Sync Documentation Plan
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --only=production
          npm install chokidar

      - name: Check for documentation changes
        id: check_changes
        run: |
          # Ä°zlenen dosyalarda deÄŸiÅŸiklik var mÄ± kontrol et
          changed_files=$(git diff --name-only HEAD~1 HEAD | grep -E "(PROGRESS\.md|SPRINT-PLANNING-2025\.md|PROJECT-STATUS-REPORT.*\.md|DEVELOPMENT-ROADMAP-2025\.md|src/lib/storage/)" || true)
          
          if [ -n "$changed_files" ] || [ "${{ github.event.inputs.force_sync }}" = "true" ]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ DeÄŸiÅŸiklik tespit edildi:"
            echo "$changed_files"
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Dokumentasyon senkronizasyonu gerektiren deÄŸiÅŸiklik bulunamadÄ±."
          fi

      - name: Run documentation sync
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          echo "ğŸ”„ DokÃ¼mantasyon senkronizasyonu baÅŸlatÄ±lÄ±yor..."
          
          # Doc sync script'ini Ã§alÄ±ÅŸtÄ±r
          node scripts/doc-sync.js sync
          
          echo "âœ… DokÃ¼mantasyon senkronizasyonu tamamlandÄ±"

      - name: Check for documentation plan changes
        if: steps.check_changes.outputs.changes_detected == 'true'
        id: check_doc_changes
        run: |
          # DokÃ¼mantasyon planÄ±nda deÄŸiÅŸiklik var mÄ± kontrol et
          if git diff --quiet docs-site/docs/meta/dokumantasyon-iyilestirme-plani-2025.html; then
            echo "doc_changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ DokÃ¼mantasyon planÄ±nda deÄŸiÅŸiklik yok"
          else
            echo "doc_changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ DokÃ¼mantasyon planÄ± gÃ¼ncellendi"
          fi

      - name: Commit documentation updates
        if: steps.check_doc_changes.outputs.doc_changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # DokÃ¼mantasyon planÄ± deÄŸiÅŸikliklerini commit et
          git add docs-site/docs/meta/dokumantasyon-iyilestirme-plani-2025.html
          
          # Commit mesajÄ±nÄ± oluÅŸtur
          commit_message="docs: otomatik dokÃ¼mantasyon senkronizasyonu

          ğŸ¤– GitHub Actions tarafÄ±ndan otomatik olarak gÃ¼ncellendi
          
          DeÄŸiÅŸiklikler:
          - Proje durumu gÃ¼ncellendi
          - Sprint ilerlemesi senkronize edildi
          - Storage implementation durumu gÃ¼ncellendi
          
          Commit SHA: ${{ github.sha }}
          Workflow: ${{ github.workflow }}
          "
          
          git commit -m "$commit_message"

      - name: Push documentation changes
        if: steps.check_doc_changes.outputs.doc_changed == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}

      - name: Create summary
        if: always()
        run: |
          echo "## ğŸ“Š DokÃ¼mantasyon Senkronizasyon Ã–zeti" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.changes_detected }}" = "true" ]; then
            echo "âœ… **Senkronizasyon Ã‡alÄ±ÅŸtÄ±rÄ±ldÄ±**" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.check_doc_changes.outputs.doc_changed }}" = "true" ]; then
              echo "ğŸ“‹ **DokÃ¼mantasyon PlanÄ± GÃ¼ncellendi**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "GÃ¼ncellenenen dosya: \`docs-site/docs/meta/dokumantasyon-iyilestirme-plani-2025.html\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "â„¹ï¸ **DokÃ¼mantasyon PlanÄ± DeÄŸiÅŸmedi**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Mevcut dokÃ¼mantasyon planÄ± zaten gÃ¼ncel." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â¸ï¸ **Senkronizasyon AtlandÄ±**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Ä°zlenen dosyalarda deÄŸiÅŸiklik tespit edilmedi." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Ä°zlenen Dosyalar" >> $GITHUB_STEP_SUMMARY
          echo "- \`PROGRESS.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`SPRINT-PLANNING-2025.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`PROJECT-STATUS-REPORT-*.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`DEVELOPMENT-ROADMAP-2025.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`src/lib/storage/**\`" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Hedef Dosya" >> $GITHUB_STEP_SUMMARY
          echo "\`docs-site/docs/meta/dokumantasyon-iyilestirme-plani-2025.html\`" >> $GITHUB_STEP_SUMMARY

  notify-status:
    runs-on: ubuntu-latest
    needs: doc-sync
    if: always()
    
    steps:
      - name: Notify completion
        run: |
          if [ "${{ needs.doc-sync.result }}" = "success" ]; then
            echo "âœ… DokÃ¼mantasyon senkronizasyonu baÅŸarÄ±yla tamamlandÄ±!"
          else
            echo "âŒ DokÃ¼mantasyon senkronizasyonunda hata oluÅŸtu!"
            echo "LÃ¼tfen workflow loglarÄ±nÄ± kontrol edin."
          fi