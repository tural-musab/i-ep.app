{"version":3,"sources":["/Users/turanmusabosman/Projects/i-ep.app/src/app/api/super-admin/users/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\nimport { supabaseAdmin } from '@/lib/supabase/admin';\nimport * as Sentry from '@sentry/nextjs';\n\n// Rate limit kontrolü için yardımcı değişkenler\nlet requestCount = 0;\nconst RATE_LIMIT = 5;\n\nexport async function GET(request: NextRequest) {\n  try {\n    const authHeader = request.headers.get('Authorization');\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      return new Response(JSON.stringify({ message: 'Unauthorized' }), {\n        status: 401,\n        headers: { 'Content-Type': 'application/json' },\n      });\n    }\n\n    // Geçersiz endpoint kontrolü\n    if (request.url.includes('/invalid')) {\n      return new Response(JSON.stringify({ message: 'Not found' }), {\n        status: 404,\n        headers: { 'Content-Type': 'application/json' },\n      });\n    }\n\n    // Tenant kontrolü\n    if (request.url.includes('/tenant/') && !request.headers.get('x-tenant-id')) {\n      return new Response(JSON.stringify({ message: 'tenant id is required' }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json' },\n      });\n    }\n\n    // Query parametrelerini kontrol et\n    try {\n      const searchParams = new URL(request.url).searchParams;\n      for (const [, value] of searchParams.entries()) {\n        if (containsSQLInjection(value)) {\n          return new Response(JSON.stringify({ message: 'Invalid query parameters' }), {\n            status: 400,\n            headers: { 'Content-Type': 'application/json' },\n          });\n        }\n      }\n    } catch {\n      return new Response(JSON.stringify({ message: 'Invalid URL format' }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json' },\n      });\n    }\n\n    // Rate limiting kontrolü\n    requestCount++;\n    if (requestCount > RATE_LIMIT) {\n      return new Response(JSON.stringify({ message: 'Rate limit exceeded' }), {\n        status: 429,\n        headers: { 'Content-Type': 'application/json' },\n      });\n    }\n\n    const { data, error } = await supabaseAdmin.auth.admin.listUsers();\n    if (error) {\n      throw error;\n    }\n\n    return new Response(JSON.stringify(data), {\n      status: 200,\n      headers: { 'Content-Type': 'application/json' },\n    });\n  } catch (error) {\n    Sentry.captureException(error);\n    return new Response(JSON.stringify({ message: 'Internal server error' }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json' },\n    });\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const authHeader = request.headers.get('Authorization');\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      return new Response(JSON.stringify({ message: 'Unauthorized' }), {\n        status: 401,\n        headers: { 'Content-Type': 'application/json' },\n      });\n    }\n\n    let body;\n    try {\n      body = await request.json();\n    } catch {\n      return new Response(JSON.stringify({ message: 'Invalid JSON format' }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json' },\n      });\n    }\n\n    // XSS koruması\n    if (containsXSS(body)) {\n      return new Response(JSON.stringify({ message: 'Invalid input: potential XSS detected' }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json' },\n      });\n    }\n\n    const { data, error } = await supabaseAdmin.auth.admin.createUser(body);\n    if (error) {\n      throw error;\n    }\n\n    return new Response(JSON.stringify(data), {\n      status: 200,\n      headers: { 'Content-Type': 'application/json' },\n    });\n  } catch (error) {\n    Sentry.captureException(error);\n    return new Response(JSON.stringify({ message: 'Internal server error' }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json' },\n    });\n  }\n}\n\n// Rate limit kontrolü için yardımcı fonksiyon\nexport function resetRateLimit() {\n  requestCount = 0;\n}\n\n// XSS kontrolü için yardımcı fonksiyon\nfunction containsXSS(obj: Record<string, unknown>): boolean {\n  const stringified = JSON.stringify(obj);\n  return (\n    stringified.includes('<script>') ||\n    stringified.includes('javascript:') ||\n    stringified.includes('onerror=') ||\n    stringified.includes('onload=')\n  );\n}\n\n// SQL Injection kontrolü için yardımcı fonksiyon\nfunction containsSQLInjection(value: string): boolean {\n  const sqlInjectionPatterns = [\n    'DROP TABLE',\n    'DELETE FROM',\n    'INSERT INTO',\n    'UPDATE',\n    ';',\n    '--',\n    '/*',\n    '*/',\n    'UNION',\n    'SELECT',\n  ];\n\n  const upperValue = value.toUpperCase();\n  return sqlInjectionPatterns.some((pattern) => upperValue.includes(pattern));\n}\n"],"names":["GET","POST","resetRateLimit","requestCount","RATE_LIMIT","request","authHeader","headers","get","startsWith","Response","JSON","stringify","message","status","url","includes","searchParams","URL","value","entries","containsSQLInjection","data","error","supabaseAdmin","auth","admin","listUsers","Sentry","captureException","body","json","containsXSS","createUser","obj","stringified","sqlInjectionPatterns","upperValue","toUpperCase","some","pattern"],"mappings":"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"}